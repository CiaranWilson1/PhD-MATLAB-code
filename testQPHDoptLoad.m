% Xf = -0.586689002649106 + 0.119498151170060i; %10dBm
% Xs = -0.298850935342029 - 0.426174195983382i;
% Xt = -0.048800896077631 - 0.039778779368374i;
% Xu= -0.000364770159219 + 0.043508243408522i;
% Xv= -0.009743533994949 + 0.002448022954559i;
% Xw= 0.038753856045761 + 0.019813506547375i;

% Xf = -0.586689002649106 + 0.119498151170060i; %10dBm
% Xs = -0.3276 - 0.4163i;
% Xt = -0.0546 - 0.0180i;
% Xu= -0.0321 + 0.0108i;
% Xv= -0.0718 + 0.0019i;
% Xw= 0.1850 + 0.0019i;

% Xf = -0.586689002649106 + 0.119498151170060i; %10dBm modI
% Xs = -0.2988 - 0.4262i;
% Xt = -0.0488 - 0.0398i;
% Xu= -0.0009 + 0.0433i;
% Xv= -0.0096 + 0.0024i;
% Xw= 0.0388 + 0.0198i;

Xf = -0.7844 + 0.1040i; %10dBm diffLSOP
Xs = -0.2541 - 0.3862i;
Xt = -0.0470 - 0.0702i;
Xu= 0.0756 + 0.0106i;
Xv= 0.0227 + 0.0385i;
Xw= -0.0311 - 0.1263i;

% Xf = -0.7844 + 0.1040i; %10 dBm qCPHD diffLSOP
% Xs = -0.2535 - 0.3873i;
% Xt = -0.0458 - 0.0703i;
% Xu = 0.0844 + 0.0081i;
% Xv = 0.0176 + 0.0478i;
% Xw =  -0.0201 - 0.1126i;
% Xz =  -0.2400 - 0.0956i;
% 
% Xf = -0.7844 + 0.1040i; %10dBm diffLSOP widely spaced
% Xs = -0.2601 - 0.3953i;
% Xt = -0.0519 - 0.0605i;
% Xu= 0.0611 + 0.0137i;
% Xv= 0.0072 + 0.0065i;
% Xw= 0.0114 - 0.1043i;

% Xf = -7.0544 - 0.8278i; %30dBm diffLSOP
% Xs = -0.3377 - 0.2169i;
% Xt = 0.0302 - 0.1103i;
% Xu= -0.0096 - 0.0132i;
% Xv= 0.0003 + 0.0030i;
% Xw= 0.0459 - 0.0011i;

% Xf = -2.046589165091140 + 0.328935533623069i; %20dBm
% Xs = -0.315397685181650 - 0.336775399313027i;
% Xt =-0.065158958008933 - 0.056304006267495i;
% Xu= -0.012484444291734 - 0.003311078489488i;
% Xv= -0.003864783378299 + 0.002858518604053i;
% Xw=0.014571727236568 + 0.014804590571468i;

% Xf = -2.046589165091140 + 0.328935533623069i; %20dBm modI
% Xs = -0.3153 - 0.3370i;
% Xt =-0.0651 - 0.0562i;
% Xu= -0.0126 - 0.0030i;
% Xv= -0.0044 + 0.0027i;
% Xw=0.0145 + 0.0149i;

a21_lsop = 0.2292 - 0.3210i;

% Xf = -3.378745715518210 + 0.434889772926056i; %25dBm
% Xs = -0.377677023896066 - 0.265388674489762i;
% Xt =-0.102508815187502 - 0.051448161425309i;
% Xu= -0.010839597076553 - 0.013308846657571i;
% Xv= -0.001705199103894 + 0.001664386743360i;
% Xw=0.037836556407859 + 0.006203144390517i;

% Xf = -3.378745715518210 + 0.434889772926056i; %25dBm modI
% Xs = -0.3773 - 0.2659i;
% Xt = -0.1022 - 0.0519i;
% Xu= -0.0112 - 0.0129i;
% Xv= -0.0021 + 0.0019i;
% Xw=0.0378 + 0.0063i;

% Xf = -4.450241047673360 + 0.431544745343981i; %30dBm
% Xs = -0.495181846666678 - 0.122221606115199i;
% Xt =-0.168578686200136 - 0.085084550768233i;
% Xu= -0.007822509266443 - 0.009866463493993i;
% Xv= -0.001263111761821 - 0.002435780947600i;
% Xw=0.034055215233933 + 0.002897722157943i;
% 
% Xf = -4.450241047673360 + 0.431544745343981i; %30dBm modI
% Xs = -0.4949 - 0.1225i;
% Xt =-0.1691 - 0.0851i;
% Xu= -0.0080 - 0.0098i;
% Xv= -0.0012 - 0.0028i;
% Xw= 0.0341 + 0.0030i;

% Xf = -0.586689002649106 + 0.119498151170060i; %10 dBm qCPHD
% Xs = -0.2990 - 0.4271i;
% Xt = -0.0488 - 0.0397i;
% Xu = -0.0084 + 0.0475i;
% Xv = -0.0105 + 0.0024i;
% Xw =  0.0391 + 0.0199i;
% Xz =  0.0248 + 0.0138i;

% Xf = -2.0466 + 0.3289i; %20 dBm qCPHD
% Xs = -0.3156 - 0.3377i;
% Xt = -0.0653 - 0.0563i;
% Xu = -0.0164 - 0.0016i;
% Xv = -0.0036 + 0.0033i;
% Xw =  0.0146 + 0.0149i;
% Xz =  0.0046 + 0.0009i;

% Xf = -4.450241047673360 + 0.431544745343981i; %30 dBm qCPHD
% Xs = -0.4949 - 0.1219i;
% Xt = -0.1686 - 0.0849i;
% Xu = -0.0084 - 0.0108i;
% Xv = -0.0011 - 0.0026i;
% Xw =  0.0340 + 0.0029i;
% Xz =  0.0002 + 0.0003i;

% Xf = -0.5867 + 0.1195i;
% Xs = -0.3089 - 0.4091i;
% Xt = -0.0486 - 0.0356i;


syms a21 a21conj a21R a21I;
assume(a21, 'real');
assume(a21conj, 'real');

%% Pade

%b21s(a21,a21conj) = Xf + Xs*a21 + Xt*a21conj + Xu*a21^2 + Xv*a21conj^2 + Xw*a21*a21conj;
%b21s(a21,a21conj) = Xf + Xs*(a21-a21_lsop) + Xt*(a21conj-conj(a21_lsop)) + Xu*(a21-a21_lsop)^2 + Xv*(a21conj-conj(a21_lsop))^2 + Xw*(a21-a21_lsop)*(a21conj-conj(a21_lsop));
b21s(a21,a21conj) = Xf + Xs*(a21) + Xt*(a21conj) + Xu*(a21)^2 + Xv*(a21conj)^2 + Xw*(a21)*(a21conj);
%b21s(a21,a21conj) = Xf + Xs*(a21) + Xt*(a21conj) + Xu*(a21)^2 + Xv*(a21conj)^2 + Xw*(a21)*(a21conj) + Xz*a21^3;
% b21s(a21,a21conj) = Xf + Xs*a21 + Xt*a21conj;
Pouts(a21,a21conj) = b21s(a21,a21conj)*conj(b21s(a21conj,a21)) - a21*a21conj;

eqn1(a21,a21conj) = diff(Pouts,a21) == 0;
eqn2(a21,a21conj) = diff(Pouts,a21conj) == 0;

eqn3 = eqn1(a21R+1j*a21I, a21R-1j*a21I);
eqn4 = eqn2(a21R+1j*a21I, a21R-1j*a21I);

soln = vpasolve(eqn3, eqn4);
a21s = soln.a21R + 1j*soln.a21I;

gammaL_opts_all_QPHD = a21s./b21s(a21s,conj(a21s));
gammaL_opts_pade = gammaL_opts_all_QPHD(abs(gammaL_opts_all_QPHD)<1);
a21s_opts_pade = a21s(abs(gammaL_opts_all_QPHD)<1);

Pout_opts_pade = Pouts(a21s(abs(gammaL_opts_all_QPHD)<1),conj(a21s(abs(gammaL_opts_all_QPHD)<1)));

%vpa((soln.a21R + 1j*soln.a21I)/b21s(soln.a21R + 1j*soln.a21I,soln.a21R - 1j*soln.a21I))

figure
sm1=smithchart;
hold all;plot(real(gammaL_opts_all_QPHD),imag(gammaL_opts_all_QPHD),'ro','LineWidth',1.5);

%XI = 0.151;
XI = 0.083545446575342;
%XY = 0.072 + 0.043i;
XY = 0.0478 - 0.0652i;

Id = XI + real(XY*a21);
Pdc = 2*28*Id;

Id1 = XI + real(XY*a21conj);
Pdc1 = 2*28*Id1;

Pouts_Pdc(a21,a21conj) = (b21s(a21,a21conj)*conj(b21s(a21conj,a21)) - a21*a21conj)./(2*28*(real(XI+XY*a21)));
Pouts_Pdc1(a21,a21conj) = (b21s(a21,a21conj)*conj(b21s(a21conj,a21)) - a21*a21conj)./(2*28*(real(XI+XY*a21conj)));

eqn5(a21,a21conj) = diff(Pouts_Pdc,a21) == 0;
eqn6(a21,a21conj) = diff(Pouts_Pdc1,a21conj) == 0;

eqn7 = eqn5(a21R+1j*a21I, a21R-1j*a21I);
eqn8 = eqn6(a21R+1j*a21I, a21R-1j*a21I);

tic;
soln1 = vpasolve(eqn7, eqn8);
toc;

a21s_eff = soln1.a21R + 1j*soln1.a21I;
b21opt1_QPHD_eff = Xf + Xs*a21s_eff + Xt*conj(a21s_eff) + Xu*(a21s_eff).^2 + Xv*conj(a21s_eff).^2 + Xw*abs(a21s_eff).^2;
gammaOpt_QPHD_eff = a21s_eff./b21opt1_QPHD_eff;

figure
sm1=smithchart;
hold all;plot(real(gammaOpt_QPHD_eff),imag(gammaOpt_QPHD_eff),'ro','LineWidth',1.5);
